
{% load rest_framework %}
<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Xmeme home page</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>


    <style type="text/css">
  		body{
  		  background: rgb(54,217,182);
  		  background: linear-gradient(90deg, rgba(54,217,182,1) 0%, rgba(32,152,126,1) 43%, rgba(0,212,255,1) 100%);
  		}


  		h1, h2, h3, h4, h5, p, span, strike{
  		  font-family: 'Montserrat', sans-serif;

  		}


  		#task-container{
  		  max-width:600px;
  		  margin:0 auto;
  		  box-shadow: 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
  		  background-color: #fff;

  		  margin-top:100px;
  		  margin-bottom:100px;

  		  justify-content: space-around;
  		  align-items: flex-start;

  		}

  		#form-wrapper{
  		  position: -webkit-sticky;
  		  position: sticky;
  		  top: 0rem;
  		  border-bottom: 1px solid  #e9e9e9;
  		  background-color: #fff;
  		  box-shadow: 0 3px 8px rgba(0,0,0,0.25);
   		  padding:40px;
  		}

  		#submit{
  		  background-color: #36d9b6;
  		  border-radius: 0;
  		  border:0;
  		  color: #fff;
  		}

  		.flex-wrapper{
  			display: flex;
  		}

  		.task-wrapper{
  		  	margin:5px;
  		  	padding: 5px;
  		  	padding:20px;
  		  	cursor: pointer;
  		  	border-bottom: 1px solid  #e9e9e9;
  		  	color: #686868;
  			}

  	</style>

  </head>
  <body>
  	<div class="container">

  		<div id="task-container">
  			<div id="form-wrapper">
  				<form id="form">
  					<div class="flex-wrapper">
  						<div style="flex: 6">
  							<input id="name" class="form-control" type="text" name="Mname" placeholder="Your name here">
                <input id="caption" class="form-control" type="text" name="Mcaption" placeholder="Caption, if any">
                <input id="url" class="form-control" type="text" name="Murl" placeholder="Add an Image url here">
  						</div>
  						<div style="flex: 1">
  							<input id="submit" class="btn" type="submit" >
  						</div>
  					</div>
  				</form>
  			</div>

  			<div id="list-wrapper">

  			</div>
  		</div>

  	</div>

    <script type="text/javascript">

        function getCookie(name) {
              var cookieValue = null;
              if (document.cookie && document.cookie !== '') {
                  var cookies = document.cookie.split(';');
                  for (var i = 0; i < cookies.length; i++) {
                      var cookie = cookies[i].trim();
                      // Does this cookie string begin with the name we want?
                      if (cookie.substring(0, name.length + 1) === (name + '=')) {
                          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                          break;
                      }
                  }
              }
              return cookieValue;
          }
        var csrftoken = getCookie('csrftoken');

        var activeItem = null
        var list_snapshot = []



        buildList()
         function buildList(){
           var wrapper=document.getElementById('list-wrapper')
           wrapper.innerHTML=''
           var url='http://127.0.0.1:8000/appCRIO/memesList'


           fetch(url).then((resp)=>resp.json()).then(function(data){
             console.log('Data:',data)
             var list=data
             for(var i in list){

               var item=`
                  <div id="data-row-${i}" class="task-wrapper flex-wrapper">
                    ${list[i].name}
                    <br>
                    ${list[i].mcaption}
                    <br>
                    <img src="${list[i].meme_url}" alt="memeIMAGE" width="300" height="300">
                    <div><button class="btn btn-sm btn-outline-info edit">Edit </button></div>
                    <div><button class="btn btn-sm btn-outline-dark delete">Delete</button></div>
                  </div>
               `
               wrapper.innerHTML+=item
             }

             for(var i in list){
               var editBtn=document.getElementsByClassName('edit')[i]

               editBtn.addEventListener('click',(function(item){
                  return function(){
                    editItem(item)
                  }
               })(list[i]))

               var delBtn=document.getElementsByClassName('delete')[i]
               delBtn.addEventListener('click',(function(item){
                  return function(){
                    deleteItem(item)
                  }
               })(list[i]))
             }


           })
         }



        var form =document.getElementById('form-wrapper')
        form.addEventListener('submit',function(e){
          e.preventDefault()
          console.log('form submitted check')
          var url='http://127.0.0.1:8000/appCRIO/memeCreate/'

          if(activeItem!=null){
            var url=`http://127.0.0.1:8000/appCRIO/memeEdit/${activeItem.meme_id}/`
            activeItem=null
          }
          var mname=document.getElementById('name').value
          var mcaption=document.getElementById('caption').value
          var murl=document.getElementById('url').value
          fetch(
            url,{
              method:'POST',
              headers:{
                'Content-type':'application/json',
                'X-CSRFToken':csrftoken,
              },
              body:JSON.stringify({'name':mname,'mcaption':mcaption,'meme_url':murl})
            }
          ).then(function(response){
            buildList()
            document.getElementById('form').reset()
          })
        })

        function editItem(item){
          console.log('Item clicked: ',item)
          activeItem=item
          document.getElementById('name').value=activeItem.name
          document.getElementById('caption').value=activeItem.mcaption
          document.getElementById('url').value=activeItem.meme_url
        }


        function deleteItem(item){
          console.log('delete clicked',item)
          var url=`http://127.0.0.1:8000/appCRIO/memeDelete/${item.meme_id}/`
          fetch(url,{
            method:'DELETE',
            headers:{
              'Content-type':'application/json',
              'X-CSRFToken':csrftoken,
            },
          }).then((response)=>{
            buildList()
          })
        }


    </script>
  </body>
</html>
